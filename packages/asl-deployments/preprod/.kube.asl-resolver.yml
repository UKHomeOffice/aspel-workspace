---
- name: resolver
  recipe: worker
  image: quay.io/ukhomeofficedigital/asl-resolver:{{config.versions.asl-resolver}}
  replicas: 1
  memory:
    requests: 32Mi
    limit: 256Mi
  cpu:
    requests: 50m
    limit: 400m
  env:
    DATABASE_HOST:
      secret: true
      name: asl-preprod-rds
      key: endpoint
    DATABASE_NAME:
      secret: true
      name: asl-preprod-rds
      key: db_name
    DATABASE_USERNAME: resolver
    DATABASE_PASSWORD:
      secret: true
      name: dbpasswords
      key: resolver
    DATABASE_PORT:
      secret: true
      name: asl-preprod-rds
      key: port
    SQS_REGION: eu-west-2
    SQS_ACCESS_KEY:
      secret: true
      name: asl-changerequests-preprod-sqs
      key: access_key_id
    SQS_SECRET:
      secret: true
      name: asl-changerequests-preprod-sqs
      key: secret_access_key
    SQS_URL:
      secret: true
      name: asl-changerequests-preprod-sqs
      key: sqs_queue_url
    JWT_SECRET:
      secret: true
      name: asl-preprod-jwt
      key: token
    S3_REGION: eu-west-2
    S3_ACCESS_KEY:
      secret: true
      name: asl-preprod-transfer-s3
      key: access_key_id
    S3_SECRET:
      secret: true
      name: asl-preprod-transfer-s3
      key: secret_access_key
    S3_BUCKET:
      secret: true
      name: asl-preprod-transfer-s3
      key: name
    S3_KMS_KEY_ID:
      secret: true
      name: asl-preprod-transfer-s3
      key: kms_key_id
    TRANSPORT_KEY:
      secret: true
      name: s3-encryption
      key: key
    TRANSPORT_IV:
      secret: true
      name: s3-encryption
      key: iv
    EMAILER_SERVICE: {{config.urls.emailer}}
    REGISTER_SERVICE: {{config.urls.public-ui}}
    KEYCLOAK_REALM: Asl-dev
    KEYCLOAK_URL: {{config.urls.keycloak}}
    KEYCLOAK_CLIENT: asl-dev-connect
    KEYCLOAK_SECRET:
      secret: true
      name: asl-preprod-auth
      key: secret
    KEYCLOAK_USERNAME:
      secret: true
      name: keycloak-admin
      key: username
    KEYCLOAK_PASSWORD:
      secret: true
      name: keycloak-admin
      key: password
    NODE_TLS_REJECT_UNAUTHORIZED: "'0'"

- name: resolver
  recipe: autoscaler
  min: 1
  max: 3

- name: expire-projects
  recipe: cronjob
  image: quay.io/ukhomeofficedigital/asl-resolver:{{config.versions.asl-resolver}}
  schedule: '0 0 * * *'
  command: npm run task -- ./tasks/expire
  memory:
    requests: 32Mi
    limit: 256Mi
  cpu:
    requests: 100m
    limit: 400m
  env:
    DATABASE_HOST:
      secret: true
      name: asl-preprod-rds
      key: endpoint
    DATABASE_NAME:
      secret: true
      name: asl-preprod-rds
      key: db_name
    DATABASE_USERNAME: resolver
    DATABASE_PASSWORD:
      secret: true
      name: dbpasswords
      key: resolver
    DATABASE_PORT:
      secret: true
      name: asl-preprod-rds
      key: port

- name: reset-billing-details
  recipe: cronjob
  image: quay.io/ukhomeofficedigital/asl-resolver:{{config.versions.asl-resolver}}
  schedule: '15 13 6 6 *' # Set to after QA deployment for QA testing
  command: npm run task -- ./tasks/reset-billing
  memory:
    requests: 32Mi
    limit: 256Mi
  cpu:
    requests: 100m
    limit: 400m
  env:
    DATABASE_HOST:
      secret: true
      name: asl-preprod-rds
      key: endpoint
    DATABASE_NAME:
      secret: true
      name: asl-preprod-rds
      key: db_name
    DATABASE_USERNAME: resolver
    DATABASE_PASSWORD:
      secret: true
      name: dbpasswords
      key: resolver
    DATABASE_PORT:
      secret: true
      name: asl-preprod-rds
      key: port
